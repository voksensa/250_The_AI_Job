# Session Log: Production Toggle Foundation (TASK-P1-001) - Research Phase

**Date**: 2025-11-21
**Task**: TASK-P1-001
**Objective**: Research and plan the minimal end-to-end Production Toggle proof of concept.

## Phase 0: Current State Analysis

### Existing `graph.py`
- **Nodes**: `planner_node`, `executor_node`.
- **State**: `AgentState` with `task`, `plan`, `result`, `messages`.
- **Events**: Uses `get_stream_writer()` to broadcast events like `{"status": "planning", ...}`.
- **LLM**: Uses `get_llm()` factory for type-safe instantiation.

### Existing `routes.py`
- **POST /tasks**: Creates a new task, generates a UUID, and starts the graph in the background using `background_tasks`.
- **GET /tasks/{id}**: Retrieves the current state from the `PostgresSaver` checkpointer.
- **WebSocket /tasks/{task_id}/stream**:
  - Accepts a WebSocket connection.
  - Expects a JSON message to start/resume (though currently logic suggests it might expect inputs).
  - Uses `graph.astream(..., stream_mode=["updates", "custom"])`.
  - Sends chunks back as JSON.

## Phase 1: MCP Research

### MCP Query 1: Next.js 15 App Router
- **Query**: `nextjs 15 app router server actions form`
- **Findings**:
  - Standard pattern is to use Server Actions for form submissions, but for this "Production Toggle" MVP where we need immediate client-side feedback and streaming, a client-side form with `fetch` is often simpler and more direct for the initial "submit and watch" flow.
  - However, we can use a Client Component for the form to handle the `onSubmit` event and trigger the API call.

### MCP Query 2: React Hooks for Streaming
- **Query**: `react hooks useEffect fetch streaming`
- **Findings**:
  - `useEffect` is the standard hook for managing side effects like WebSocket connections.
  - Cleanup function in `useEffect` is critical to close the WebSocket connection when the component unmounts.

### MCP Query 3: WebSocket in React/Next.js
- **Query**: `nextjs websocket client connection react`
- **Findings**:
  - Native `WebSocket` API is fully supported in browser environments.
  - Pattern:
    ```typescript
    useEffect(() => {
      const ws = new WebSocket(url);
      ws.onmessage = (event) => { ... };
      return () => ws.close();
    }, []);
    ```

### MCP Query 4: Server-Sent Events vs WebSocket
- **Query**: `server sent events vs websocket streaming`
- **Findings**:
  - WebSockets are bidirectional, SSE is unidirectional.
  - Since we might want to send signals *to* the agent later (e.g., "stop", "approve"), WebSockets provide more flexibility for the "Production Toggle" vision.
  - **Decision**: Stick with WebSocket as implemented in `routes.py`.

### MCP Query 5: FastAPI CORS for Next.js
- **Query**: `fastapi cors configuration nextjs localhost`
- **Findings**:
  - Must explicitly allow `http://localhost:3000` in `allow_origins`.
  - `allow_credentials=True` is needed if cookies/headers are involved.

## Phase 2: Refined Implementation Plan

### Frontend Strategy
- **Framework**: Next.js 15 (App Router).
- **Component**: `app/page.tsx` will be a Client Component (`'use client'`) to manage the WebSocket state.
- **Styling**: Tailwind CSS for a clean, "Production" look (dark mode, distinct status indicators).
- **API**: Simple `fetch` wrapper in `lib/api.ts`.

### Backend Strategy
- **CORS**: Update `main.py` to explicitly allow `http://localhost:3000`.
- **WebSocket**:
  - The current implementation expects a message to start. We should probably simplify this for the MVP: if the connection opens, start streaming the current state or updates.
  - **Refinement**: Ensure `routes.py` handles the initial connection gracefully without requiring a complex handshake for this MVP.

### Integration
- **Flow**:
  1. User types task -> `POST /tasks` -> returns `task_id`.
  2. Frontend opens `ws://localhost:8002/tasks/{task_id}/stream`.
  3. Backend streams events.
  4. Frontend updates UI.

## Next Steps
Proceed to Execution Phase:
1. Initialize Next.js app.
2. Implement Frontend components.
3. Refine Backend CORS and WebSocket logic.
4. Verify end-to-end.
